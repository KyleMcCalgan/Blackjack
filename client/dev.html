<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dev Admin Panel - Blackjack Server</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: #0a0a0a;
      color: #00ff00;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      padding: 20px;
      background: #1a1a1a;
      border: 2px solid #00ff00;
      margin-bottom: 20px;
      border-radius: 8px;
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .header .status {
      color: #ffff00;
      font-size: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: #1a1a1a;
      border: 2px solid #00ff00;
      border-radius: 8px;
      padding: 20px;
    }

    .panel-title {
      font-size: 18px;
      color: #ffff00;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #00ff00;
    }

    .button-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }

    button {
      background: #003300;
      color: #00ff00;
      border: 2px solid #00ff00;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }

    button:hover {
      background: #00ff00;
      color: #000;
    }

    button:active {
      transform: scale(0.95);
    }

    select {
      background: #001100;
      color: #00ff00;
      border: 2px solid #00ff00;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: #00ff00;
      box-shadow: 0 0 10px #00ff0050;
    }

    select option {
      background: #001100;
      color: #00ff00;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      color: #ffff00;
      font-size: 14px;
    }

    input, select, textarea {
      width: 100%;
      background: #0a0a0a;
      color: #00ff00;
      border: 2px solid #00ff00;
      padding: 10px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      border-radius: 4px;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .log-container {
      background: #0a0a0a;
      border: 2px solid #00ff00;
      border-radius: 4px;
      padding: 15px;
      height: 400px;
      overflow-y: auto;
      font-size: 12px;
      line-height: 1.5;
    }

    .log-entry {
      margin-bottom: 8px;
      word-wrap: break-word;
    }

    .log-entry.error {
      color: #ff0000;
    }

    .log-entry.warning {
      color: #ffaa00;
    }

    .log-entry.success {
      color: #00ffff;
    }

    .info-display {
      background: #0a0a0a;
      border: 2px solid #00ff00;
      border-radius: 4px;
      padding: 15px;
      font-size: 13px;
      line-height: 1.8;
    }

    .info-row {
      margin-bottom: 8px;
    }

    .info-label {
      color: #ffff00;
      display: inline-block;
      min-width: 150px;
    }

    .player-item {
      background: #0a0a0a;
      border: 1px solid #00ff00;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
    }

    .player-name {
      font-weight: bold;
      color: #ffff00;
      margin-bottom: 5px;
    }

    .player-detail {
      font-size: 12px;
      margin-left: 10px;
      color: #00ff00;
    }

    .command-output {
      background: #0a0a0a;
      border: 2px solid #00ff00;
      border-radius: 4px;
      padding: 15px;
      min-height: 100px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 12px;
      white-space: pre-wrap;
      margin-top: 10px;
    }

    .auth-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0a0a0a;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .auth-box {
      background: #1a1a1a;
      border: 2px solid #00ff00;
      padding: 40px;
      border-radius: 8px;
      text-align: center;
      max-width: 400px;
    }

    .auth-box h2 {
      color: #ffff00;
      margin-bottom: 20px;
    }

    .auth-box input {
      margin-bottom: 20px;
    }

    .error-message {
      color: #ff0000;
      margin-top: 10px;
      font-size: 14px;
    }

    .hidden {
      display: none;
    }

    .clear-logs {
      float: right;
      padding: 5px 10px;
      font-size: 12px;
      margin-top: -5px;
    }
  </style>
</head>
<body>
  <!-- Authentication Screen -->
  <div id="authScreen" class="auth-screen">
    <div class="auth-box">
      <h2>üîê Dev Admin Panel</h2>
      <p style="margin-bottom: 20px; color: #00ff00;">Enter access key to continue</p>
      <input type="password" id="authKey" placeholder="Access Key" />
      <button onclick="authenticate()">Unlock</button>
      <div id="authError" class="error-message hidden"></div>
    </div>
  </div>

  <!-- Main Admin Panel -->
  <div id="mainPanel" class="hidden">
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>üéÆ DEV ADMIN PANEL üéÆ</h1>
        <div class="status">Connected to server | Session: <span id="sessionId">Loading...</span></div>
      </div>

      <!-- Main Grid -->
      <div class="grid">
        <!-- Game Control -->
        <div class="panel">
          <div class="panel-title">üéØ Game Control</div>
          <div class="button-grid">
            <button onclick="executeCommand('/start')">Start Game</button>
            <button onclick="executeCommand('/end')">End Game</button>
            <button onclick="showKickDialog()">Kick Player</button>
            <button onclick="showTransferDialog()">Transfer Host</button>
          </div>

          <div class="input-group">
            <label>Custom Command:</label>
            <input type="text" id="customCommand" placeholder="/command args" onkeypress="if(event.key==='Enter') executeCustomCommand()" />
            <button onclick="executeCustomCommand()" style="margin-top: 10px;">Execute</button>
          </div>

          <div id="commandOutput" class="command-output"></div>
        </div>

        <!-- Server Info -->
        <div class="panel">
          <div class="panel-title">üìä Server Info</div>
          <div class="info-display" id="serverInfo">
            <div class="info-row"><span class="info-label">Phase:</span><span id="infoPhase">-</span></div>
            <div class="info-row"><span class="info-label">Round:</span><span id="infoRound">-</span></div>
            <div class="info-row"><span class="info-label">Players:</span><span id="infoPlayers">-</span></div>
            <div class="info-row"><span class="info-label">Local URL:</span><span id="infoLocal">http://localhost:3000</span></div>
            <div class="info-row"><span class="info-label">Public URL:</span><span id="infoPublic">-</span></div>
            <div class="info-row"><span class="info-label">Starting Bankroll:</span><span id="infoBankroll">-</span></div>
            <div class="info-row"><span class="info-label">Min Bet:</span><span id="infoMinBet">-</span></div>
            <div class="info-row"><span class="info-label">Max Bet:</span><span id="infoMaxBet">-</span></div>
          </div>
          <button onclick="refreshInfo()" style="margin-top: 10px; width: 100%;">Refresh Info</button>
        </div>
      </div>

      <!-- Bottom Grid -->
      <div class="grid">
        <!-- Testing & Debug -->
        <div class="panel">
          <div class="panel-title">üß™ Testing & Debug</div>
          <div class="button-grid">
            <button onclick="executeCommand('/test-mode on')">Test Mode ON</button>
            <button onclick="executeCommand('/test-mode off')">Test Mode OFF</button>
            <button onclick="executeCommand('/autoplay on')">Autoplay ON</button>
            <button onclick="executeCommand('/autoplay off')">Autoplay OFF</button>
            <button onclick="executeCommand('/next')">Next Phase</button>
            <button onclick="executeCommand('/debug')">Toggle Debug</button>
            <button onclick="executeCommand('/state')">View State</button>
            <button onclick="executeCommand('/scenario')">List Scenarios</button>
            <button onclick="executeCommand('/deal clear')">Clear Cards</button>
          </div>

          <div class="input-group">
            <label>Deal Cards (e.g., AS KH 10D):</label>
            <input type="text" id="dealCards" placeholder="AS KH 10D 7C" />
            <div style="display: flex; gap: 10px; margin-top: 10px;">
              <select id="scenarioSelect" style="flex: 1;">
                <option value="">-- Select Scenario --</option>
                <optgroup label="Blackjack">
                  <option value="blackjack">Player Blackjack</option>
                  <option value="dealer-blackjack">Dealer Blackjack (Insurance)</option>
                  <option value="bust">Player Bust</option>
                </optgroup>
                <optgroup label="Perfect Pairs">
                  <option value="colored-pair">Colored Pair (12:1)</option>
                  <option value="perfect-pair">Perfect Pair (25:1)</option>
                </optgroup>
                <optgroup label="Bust It">
                  <option value="bust-it-3cards">Bust It - 3 Cards (2:1)</option>
                  <option value="bust-it-4cards">Bust It - 4 Cards (4:1)</option>
                  <option value="bust-it-5cards">Bust It - 5 Cards (15:1)</option>
                  <option value="bust-it-6cards">Bust It - 6 Cards (50:1)</option>
                  <option value="bust-it-7cards">Bust It - 7 Cards (100:1)</option>
                  <option value="bust-it-8cards">Bust It - 8+ Cards (250:1)</option>
                </optgroup>
                <optgroup label="21+3">
                  <option value="21plus3-flush">21+3 - Flush (5:1)</option>
                  <option value="21plus3-straight">21+3 - Straight (10:1)</option>
                  <option value="21plus3-three-kind">21+3 - Three of a Kind (30:1)</option>
                  <option value="21plus3-straight-flush">21+3 - Straight Flush (40:1)</option>
                  <option value="21plus3-suited-three">21+3 - Suited Three of a Kind (100:1)</option>
                </optgroup>
                <optgroup label="Splits">
                  <option value="split-aces">Split Aces</option>
                  <option value="split-tens">Split Tens</option>
                </optgroup>
              </select>
              <button onclick="loadSelectedScenario()" style="min-width: 100px;">Load</button>
            </div>
            <button onclick="executeDeal()" style="margin-top: 10px; width: 100%;">Deal Cards</button>
          </div>
        </div>

        <!-- Statistics -->
        <div class="panel">
          <div class="panel-title">üìà Statistics</div>
          <div class="button-grid">
            <button onclick="executeCommand('/stats')">Session Stats</button>
            <button onclick="executeCommand('/export')">Export Stats</button>
            <button onclick="executeCommand('/history 20')">Show History</button>
            <button onclick="executeCommand('/clear-stats')">Clear Stats</button>
          </div>
        </div>
      </div>

      <!-- Players List -->
      <div class="panel">
        <div class="panel-title">üë• Connected Players</div>
        <div id="playersList">No players connected</div>
        <button onclick="refreshPlayers()" style="margin-top: 10px; width: 100%;">Refresh Players</button>
      </div>

      <!-- Live Server Logs -->
      <div class="panel">
        <div class="panel-title">
          üìú Live Server Logs
          <button class="clear-logs" onclick="clearLogs()">Clear Logs</button>
        </div>
        <div id="logs" class="log-container"></div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let socket;
    let authenticated = false;

    // Check for key in URL params on load
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const keyParam = urlParams.get('key');

      if (keyParam) {
        document.getElementById('authKey').value = keyParam;
        authenticate();
      }
    });

    function authenticate() {
      const key = document.getElementById('authKey').value;

      if (!key) {
        document.getElementById('authError').textContent = 'Please enter an access key';
        document.getElementById('authError').classList.remove('hidden');
        return;
      }

      // Connect to server and validate key
      const tempSocket = io();

      tempSocket.on('connect', () => {
        tempSocket.emit('admin-validate-key', { key });
      });

      tempSocket.on('admin-key-validated', (data) => {
        if (data.valid) {
          authenticated = true;
          document.getElementById('authScreen').classList.add('hidden');
          document.getElementById('mainPanel').classList.remove('hidden');
          tempSocket.disconnect();
          initializeSocket();
        } else {
          document.getElementById('authError').textContent = 'Invalid access key';
          document.getElementById('authError').classList.remove('hidden');
          tempSocket.disconnect();
        }
      });

      // Timeout after 5 seconds
      setTimeout(() => {
        if (!authenticated) {
          document.getElementById('authError').textContent = 'Connection timeout. Please try again.';
          document.getElementById('authError').classList.remove('hidden');
          tempSocket.disconnect();
        }
      }, 5000);
    }

    function initializeSocket() {
      socket = io();

      socket.on('connect', () => {
        addLog('‚úì Connected to server', 'success');
        refreshInfo();
        refreshPlayers();
      });

      socket.on('disconnect', () => {
        addLog('‚úó Disconnected from server', 'error');
      });

      // Listen for admin logs
      socket.on('admin-log', (data) => {
        addLog(data.message, data.type);
      });

      // Listen for command output
      socket.on('admin-command-output', (data) => {
        displayCommandOutput(data.output);
      });

      // Listen for game state updates
      socket.on('game-state', (state) => {
        updateServerInfo(state);
      });

      // Listen for player updates
      socket.on('player-joined', () => {
        refreshPlayers();
      });

      socket.on('player-left', () => {
        refreshPlayers();
      });

      // Setup admin-specific listeners
      setupAdminListeners();
    }

    function executeCommand(command) {
      if (!socket) return;

      addLog(`> ${command}`, 'success');
      socket.emit('admin-command', { command });
    }

    function executeCustomCommand() {
      const input = document.getElementById('customCommand');
      const command = input.value.trim();

      if (command) {
        executeCommand(command);
        input.value = '';
      }
    }

    function executeDeal() {
      const cards = document.getElementById('dealCards').value.trim();
      if (cards) {
        executeCommand(`/deal ${cards}`);
      }
    }

    function loadSelectedScenario() {
      const select = document.getElementById('scenarioSelect');
      const scenarioName = select.value;

      if (!scenarioName) {
        addLog('[Scenario] Please select a scenario first', 'error');
        return;
      }

      // Correct card dealing order for 1 player:
      // Card 1: Player first card
      // Card 2: Dealer upcard (face up)
      // Card 3: Player second card
      // Card 4: Dealer hole card (face down)
      // Card 5+: Hit cards, etc.
      const scenarios = {
        'blackjack': {
          cards: 'AS 10D KH 9H',
          desc: 'Player: A‚ô† K‚ô• (Blackjack), Dealer: 10‚ô¶ 9‚ô• (19)'
        },
        'dealer-blackjack': {
          cards: '7H AH 8D KS',
          desc: 'Player: 7‚ô• 8‚ô¶ (15), Dealer: A‚ô• K‚ô† (Blackjack - Insurance test)'
        },
        'bust': {
          cards: '10H AH 7D 6D 8S',
          desc: 'Player: 10‚ô• 7‚ô¶ then hits 8‚ô† (Bust 25), Dealer: A‚ô• 6‚ô¶'
        },
        'colored-pair': {
          cards: '6H 7D 6D 10S',
          desc: 'Player: 6‚ô• 6‚ô¶ (Colored Pair 12:1 - both red), Dealer: 7‚ô¶ 10‚ô†'
        },
        'perfect-pair': {
          cards: 'KH 7D KH 10S',
          desc: 'Player: K‚ô• K‚ô• (Perfect Pair 25:1 - same suit), Dealer: 7‚ô¶ 10‚ô†'
        },
        // Bust It scenarios
        'bust-it-3cards': {
          cards: '10H 5D 9H 10D 10S',
          desc: 'Dealer busts with 3 cards (5‚ô¶ 10‚ô¶ 10‚ô† = 25) - Bust It 2:1'
        },
        'bust-it-4cards': {
          cards: '10H 5D 9H 5H 5S 7S',
          desc: 'Dealer busts with 4 cards (5‚ô¶ 5‚ô• 5‚ô† 7‚ô† = 22) - Bust It 4:1'
        },
        'bust-it-5cards': {
          cards: '10H 2D 9H 3H 4S 5S 8S',
          desc: 'Dealer busts with 5 cards (2‚ô¶ 3‚ô• 4‚ô† 5‚ô† 8‚ô† = 22) - Bust It 15:1'
        },
        'bust-it-6cards': {
          cards: '10H 2D 9H 2H 3S 4S 5S 10S',
          desc: 'Dealer busts with 6 cards (2‚ô¶ 2‚ô• 3‚ô† 4‚ô† 5‚ô† 10‚ô† = 26) - Bust It 50:1'
        },
        'bust-it-7cards': {
          cards: '10H 2D 9H 2H 2S 2C 3S 4S 10S',
          desc: 'Dealer busts with 7 cards (2‚ô¶ 2‚ô• 2‚ô† 2‚ô£ 3‚ô† 4‚ô† 10‚ô† = 25) - Bust It 100:1'
        },
        'bust-it-8cards': {
          cards: '10H AD 9H AH 2S 2D 3S 4S AS 10S',
          desc: 'Dealer busts with 8 cards (A‚ô¶ A‚ô• 2‚ô† 2‚ô¶ 3‚ô† 4‚ô† A‚ô† 10‚ô† = 24) - Bust It 250:1'
        },
        // 21+3 scenarios
        '21plus3-flush': {
          cards: '5H 9H 7H 10D',
          desc: 'Player 5‚ô• 7‚ô• + Dealer 9‚ô• = Flush (all hearts) - 21+3 5:1'
        },
        '21plus3-straight': {
          cards: '5H 6D 7S 10H',
          desc: 'Player 5‚ô• 7‚ô† + Dealer 6‚ô¶ = Straight (5-6-7) - 21+3 10:1'
        },
        '21plus3-three-kind': {
          cards: '8H 8D 8S 10H',
          desc: 'Player 8‚ô• 8‚ô† + Dealer 8‚ô¶ = Three of a Kind - 21+3 30:1'
        },
        '21plus3-straight-flush': {
          cards: '5H 6H 7H 10D',
          desc: 'Player 5‚ô• 7‚ô• + Dealer 6‚ô• = Straight Flush (5-6-7 hearts) - 21+3 40:1'
        },
        '21plus3-suited-three': {
          cards: 'KH KH KH 10D',
          desc: 'Player K‚ô• K‚ô• + Dealer K‚ô• = Suited Three of a Kind - 21+3 100:1'
        },
        'split-aces': {
          cards: 'AS 7D AH 10H KH QD',
          desc: 'Player: A‚ô† A‚ô• (Split Aces), Dealer: 7‚ô¶ 10‚ô•'
        },
        'split-tens': {
          cards: '10H 7S 10D KH QD 9H',
          desc: 'Player: 10‚ô• 10‚ô¶ (Split Tens), Dealer: 7‚ô† K‚ô•'
        }
      };

      const scenario = scenarios[scenarioName];
      if (scenario) {
        // Fill the input field with the scenario cards
        document.getElementById('dealCards').value = scenario.cards;

        // Show a notification with description
        addLog(`[Scenario] ${scenarioName}: ${scenario.desc}`, 'normal');
        addLog(`[Scenario] Cards loaded: ${scenario.cards}`, 'normal');

        // Reset dropdown
        select.value = '';
      }
    }

    function showKickDialog() {
      const playerName = prompt('Enter player name or seat number to kick:');
      if (playerName) {
        executeCommand(`/kick ${playerName}`);
      }
    }

    function showTransferDialog() {
      const playerName = prompt('Enter player name or seat number to transfer host to:');
      if (playerName) {
        executeCommand(`/transfer ${playerName}`);
      }
    }

    function refreshInfo() {
      if (socket) {
        socket.emit('admin-get-info');
      }
    }

    function refreshPlayers() {
      if (socket) {
        socket.emit('admin-get-players');
      }
    }

    function updateServerInfo(state) {
      if (!state) return;

      document.getElementById('sessionId').textContent = state.sessionId || 'N/A';
      document.getElementById('infoPhase').textContent = state.phase || '-';
      document.getElementById('infoRound').textContent = state.roundNumber || '0';
      document.getElementById('infoPlayers').textContent = `${state.players?.length || 0}/5`;

      if (state.config) {
        document.getElementById('infoBankroll').textContent = `$${state.config.startingBankroll}`;
        document.getElementById('infoMinBet').textContent = `$${state.config.minBet}`;
        document.getElementById('infoMaxBet').textContent = `$${state.config.maxBet}`;
      }
    }

    // Listen for info and players responses (these should be inside initializeSocket)
    function setupAdminListeners() {
      socket.on('admin-info', (data) => {
        updateServerInfo(data.state);
        document.getElementById('infoPublic').textContent = data.ngrokUrl || 'Not available';
      });

      socket.on('admin-players', (data) => {
        displayPlayers(data.players);
      });
    }

    function displayPlayers(players) {
      const container = document.getElementById('playersList');

      if (!players || players.length === 0) {
        container.innerHTML = 'No players connected';
        return;
      }

      let html = '';
      players.forEach(player => {
        const hostBadge = player.isHost ? ' [HOST]' : '';
        const elimBadge = player.eliminated ? ' [ELIMINATED]' : '';

        html += `
          <div class="player-item">
            <div class="player-name">Seat ${player.seat}: ${player.name}${hostBadge}${elimBadge}</div>
            <div class="player-detail">Bankroll: $${player.bankroll} | Bet: $${player.currentBet}</div>
            <div class="player-detail">ID: ${player.id}</div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function displayCommandOutput(output) {
      const container = document.getElementById('commandOutput');
      container.textContent = output;
      container.scrollTop = container.scrollHeight;
    }

    function addLog(message, type = 'normal') {
      const logsContainer = document.getElementById('logs');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;

      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;

      logsContainer.appendChild(entry);
      logsContainer.scrollTop = logsContainer.scrollHeight;

      // Keep only last 200 log entries
      while (logsContainer.children.length > 200) {
        logsContainer.removeChild(logsContainer.firstChild);
      }
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
      addLog('Logs cleared', 'success');
    }
  </script>
</body>
</html>
